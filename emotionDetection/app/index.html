<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Estimulación: Detección de emociones</title>


  <link rel="stylesheet" href="styles/emoDetectStyle.css">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="styles/bootstrap.min.css">
  <script>let $ = require('jquery');</script>
  <script>require('popper.js');</script>
  <script>require('bootstrap');</script>
  <script>if (window.module) module = window.module;</script>
</head>

<body style="background-color:white;">
  <div class="container">
    <div class="form-group" id="nameForm">
      <label for="nombre">Nombre del participante</label>
      <input type="text" class="form-control" id="name" placeholder="Angel">

      <button type="button" onclick="start(); this.disabled=true;" id="startEmoDetect" class="btn btn-primary"
        disabled="">Iniciar</button>
    </div>
    <div class="center" id="text" width="320" height="240">


      <h1 id="count"></h1>

    </div>
    <video width="800" height="600" autoplay controls class="centerVideo" style="display: none;" id="videoEmo">
      <source src="" type="video/mp4">
    </video>
    <form class="AffectiveSlider">

      <div id='AffectiveSlider' style="display: none;">

      </div>
      <button type="button" onclick="calificar()" id="rateBtn" class="btn btn-primary"
        style="display: none;">Calificar</button>


    </form>

  </div>

  <script>
    var udp = require('dgram');
    var server = udp.createSocket('udp4');
    const PRE_RUN_TIME = 2000;
    var buffer = "";
    var label = "prerun,0,";
    var name = null;
    const fs = require('fs');
    var videoStarted;
    var videoEnded = false;
    var exitacion = null;
    var placer = null;
    var video = $('#videoEmo');
    var count = $('#count');
    var slider = $('#AffectiveSlider');
    var rateBtn = $('#rateBtn');
    var form = $('#nameForm');

    var current = 0;
    const timer = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    document.getElementById('videoEmo').addEventListener('ended', onStopVideo, false);
    function onStopVideo(e) {
      console.log("video ended");
      slider.show();
      rateBtn.show();
      videoEnded = true;
      if (exitacion == null || placer == null) {
        label = "postrun,0,";
      } else {
        start();
      }
    }

    document.getElementById('videoEmo').addEventListener('loadedmetadata', onStartVideo, false);
    function onStartVideo(e) {
      videoEnded = false;
      $("#rateBtn").prop("disabled", false);
    }

    $("#name").keyup(function () {
      if (this.value.length > 0) {
        $("#startEmoDetect").prop("disabled", false);

      } else {
        $("#startEmoDetect").prop("disabled", true);
      }
    });

    var videos = [
      { vid: 'resources/videoRobot/01_austero_editado.mp4' },
      { vid: 'resources/videoRobot/1_editado.mp4' },
      { vid: 'resources/videoRobot/02_austero_editado.mp4' },
      { vid: 'resources/videoRobot/2_editado.mp4' },
      { vid: 'resources/videoRobot/03_austero_editado.mp4' },
      { vid: 'resources/videoRobot/3_editado.mp4' },
      { vid: 'resources/videoRobot/04_austero_editado.mp4' },
      { vid: 'resources/videoRobot/4_editado.mp4' },
      { vid: 'resources/videoRobot/05_austero_editado.mp4' },
      { vid: 'resources/videoRobot/5_editado.mp4' },
      { vid: 'resources/videoRobot/06_austero_editado.mp4' },
      { vid: 'resources/videoRobot/6_editado.mp4' }
    ];
/*

    var videos = [
      { vid: 'resources/video/LCD Soundsystem - New York, I Love You But Youre Bringing Me Down.mp4' },
      { vid: 'resources/video/kings of convenience - weight of my words.mp4' },
      { vid: 'resources/video/James Blunt - Goodbye My Lover [OFFICIAL VIDEO].mp4' },
      { vid: 'resources/video/A Fine Frenzy - Almost Lover Official Video.mp4' },
      { vid: 'resources/video/The Go! Team - Huddle Formation.mp4' },
      { vid: 'resources/video/STIGMATA - Ð ÐÐ¢Ð ÐÐÐÐÐÐ ÐÐÐÐ (FAN VIDEO, 2010).mp4' },
      { vid: 'resources/video/Parkway Drive - Smoke Em If Ya Got Em.mp4' },
      { vid: 'resources/video/OREN LAVIE  Her Morning Elegance .mp4' },
      { vid: 'resources/video/MORTEMIA - The One I Once Was (Official).mp4' },
      { vid: 'resources/video/Emiliana Torrini - Jungle Drum (Official Video).mp4' },
      { vid: 'resources/video/Bishop Allen - Butterfly Nets.mp4' }
    ];

*/
    function start() {
      form.hide();
      videoEnded = false;
      document.getElementById("AS-arousal").value = 0.5;
      document.getElementById("AS-pleasure").value = 0.5;
      placer = null;
      exitacion = null;
      video.hide();
      serverFunc(null);
      main();
      async function main(i) {
        slider.hide();
        rateBtn.hide();
        label = "prerun,0,";
        count.text(current + 1);
        count.show();
        await timer(2000);
        count.text('✚');
        await timer(5000);
        if (current < videos.length) {
          count.hide();
          label = "video," + (current + 1) + ",";
          document.getElementById("videoEmo").src = videos[current].vid;
          video.show();
        } else {
          count.text("Fin");
          count.show();
          label = "postrun,0,";
          prePost();
          serverFunc('stop');
        }
        current++;
      }

      async function prePost() {
        await timer(PRE_RUN_TIME);
      }

    }

    function calificar() {
      exitacion = document.getElementById("AS-arousal").value;
      placer = document.getElementById("AS-pleasure").value;
      $("#rateBtn").prop("disabled", true);
      var ratings = "";
      ratings = current + "," + exitacion + "," + placer;
      ratings += "\n";
      console.log(ratings)
      fs.appendFile("app/data/" + name + "-ratings.csv", ratings, (err) => {
        if (err) {
          console.log("error: " + err)
        }
      });
      start();
    }

    function serverFunc(option) {
    name = document.getElementById("name").value;
    }
    window.onload = function () {
      startServer();
      document.getElementById("count").innerHTML = "0";
      var aff_slider = document.getElementById('AffectiveSlider');

      var arousal_part = 'Nivel de excitación \n<div class="arousal"> \n<object class="arousal_svg" type="image/svg+xml" data="resources/images/AS_sleepy.svg"></object> \n<input type="range" name="AS-arousal" id="AS-arousal" value=".5" min="0" max="1" step=".01" /> \n<object class="arousal_svg" type="image/svg+xml" data="resources/images/AS_wideawake.svg"></object> \n<object class="intensity_cue_svg" type="image/svg+xml" data="resources/images/AS_intensity_cue.svg"></object></div>';

      var pleasure_part = 'Nivel de placer \n<div class="pleasure"> \n<object class="arousal_svg" type="image/svg+xml" data="resources/images/AS_unhappy.svg"></object> \n<input type="range" name="AS-pleasure" id="AS-pleasure" value=".5" min="0" max="1" step=".01" /> \n<object class="arousal_svg" type="image/svg+xml" data="resources/images/AS_happy.svg"></object> \n<object class="intensity_cue_svg" type="image/svg+xml" data="resources/images/AS_intensity_cue.svg"></object> \n</div>';

      if (Math.random() > 0.5) {
        aff_slider.innerHTML = arousal_part + pleasure_part;
      }
      else {
        aff_slider.innerHTML = pleasure_part + arousal_part;
      }
    }

    function startServer() {
        // En caso de error
        server.on('error', (err) => {
            console.error("Error:", err);
            server.close();
            process.exit();
        })

        // En caso de que 
        server.on('listening', function () {
            var address = server.address();
            var port = address.port;
            var family = address.family;
            var ipaddr = address.address;
            console.log('Server is listening at port ' + port);
            console.log('Server ip :' + ipaddr);
            console.log('Server is IP4/IP6 : ' + family);
        });


        // Se llama cuando llega un nuevo datagram msg
        server.on('message', function (msg, info) {
          if(name!=null||name!='null'){
          var msgLength = msg.toString().length
          buffer = (label + msg.toString().substring(22,msgLength-4));
          buffer += "\n";
          fs.appendFile("app/data/" + name + ".csv", buffer, (err) => {
            if (err) {
              console.log("error: " + err)
            }
            else {
              console.log("saved data eeg file");
            }
          });}
      })
        server.bind(12345);
    }
  </script>


</body>

</html>