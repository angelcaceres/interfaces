<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Estimulaci√≥n: Imagineria Mental</title>


  <link rel="stylesheet" href="styles/mentalImgStyle.css">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="styles/bootstrap.min.css" />
<script>let $ = require('jquery');</script>
<script>require('popper.js');</script>
<script>require('bootstrap');</script>
<!--<script src="scripts/openbci.js"></script>   Funciones para trabajar con Cyton -->

  <script>if (window.module) module = window.module;</script>
</head>

<body style="background-color:grey;">
  <div class="container">
    <div class="form-group">
      <label for="nombre" >Nombre</label>
      <input type="text" class="form-control" id="name" placeholder="Angel">

      <button type="button" onclick="start()" id="startAdjustement" class="btn btn-primary" >Iniciar</button>
      <img id="flip" class="flip" src="">
      <div class="center" id="text"></div>
    </div>
  </div>

  <script>
    const PRE_RUN_TIME = 2000;
    const POST_RUN_TIME = 0500;
    const PRE_SEQ_TIME = 2000;
    const POST_SEQ_TIME = 2000;
    var buffer = "";
    var label = "";

    var images = [
      { label: "fitting,", img: 'resources/mentalImg/img/carretera.jpeg', text: '000' },
      { label: "fitting,", img: 'resources/mentalImg/img/ciudad.jpg', text: '000' },
      { label: "fitting,", img: 'resources/mentalImg/img/construccion.jpeg', text: '000' },
      { label: "fitting,", img: 'resources/mentalImg/img/fabrica.jpg', text: '000' },
      { label: "fitting,", img: 'resources/mentalImg/img/terreno.jpg', text: '000' },
      { label: "perception,", img: 'resources/mentalImg/img/cereal.jpg', text: 'crl' },
      { label: "perception,", img: 'resources/mentalImg/img/cocacola.jpg', text: 'coca' },
      { label: "perception,", img: 'resources/mentalImg/img/galletas.jpg', text: 'gllt' },
      { label: "perception,", img: 'resources/mentalImg/img/pastillas.jpg', text: 'mdcn' },
      { label: "perception,", img: 'resources/mentalImg/img/telefono.jpg', text: 'tlfn' },
      { label: "imagery,", img: null, text: 'crl' },
      { label: "imagery,", img: null, text: 'coca' },
      { label: "imagery,", img: null, text: 'gllt' },
      { label: "imagery,", img: null, text: 'mdcn' },
      { label: "imagery,", img: null, text: 'tlfn' }
    ];
    
    var text = $('#text');
    var flip = $('#flip');
    function start() {
      
      var current = 0;
      var array = [];
      const timer = (ms) => new Promise(resolve => setTimeout(resolve, ms));
      startServer();
      const interval = setInterval(function () {
        prePost();
        label = "prerun,";
        array = images;
        main(current);
        if (current < array.length - 1) {
          current++
        } else {
          clearInterval(interval);
          label = "postrun,";
          prePost();
          writeFile();
          
        }

      }, 14200);

      async function main(i) {

        await timer(PRE_SEQ_TIME);
        label = "preseq,";
        text.text('.');
        await timer(4000);
        if (array[i].img != null) {
          label = array[i].label
          text.text('');
          flip.attr('src', array[i].img);
        } else {
          text.text('.');
        }
        flip.show();

        await timer(1600);
        flip.hide();
        flip.attr('src', '');
        text.text(array[i].text);

        await timer(600);
        text.text('');
        await timer(POST_SEQ_TIME);
        label = "postseq,"
      }

      async function prePost() {
        await timer(PRE_RUN_TIME);
      }

    }

    function startServer() {
        var udp = require('dgram');
        var server = udp.createSocket('udp4');
        server.on('error', (err) => {
            console.error("Error:", err);
            server.close();
            process.exit();
        })

        // En caso de que 
        server.on('listening', function () {
            var address = server.address();
            var port = address.port;
            var family = address.family;
            var ipaddr = address.address;
        });
        server.on('message', function (msg, info) {
          var len = msg.toString().length;
          buffer += (label + msg.toString().substring(22,len-4));
          buffer += "\n";
        });

        server.bind("12345");
    }

    function writeFile(){
      var name = document.getElementById("name").value;
      const fs = require('fs'); 
      fs.writeFile("app/data/" + name + ".csv", buffer, (err) => {
                if(err) console.log("error: " + err)
                else console.log("saved data eeg file");
            });

    }
    
  </script>


</body>

</html>